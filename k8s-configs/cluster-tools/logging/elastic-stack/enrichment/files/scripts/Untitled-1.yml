/usr/share/elasticsearch/config
    jvm.options
    ...

/enrichment-shared-volume
    /certificates
        ...
    /elasticsearch
        elasticsearch.keystore
        elasticsearch.yml
        instances.yml
    /kibana
        kibana.yml

/usr/share/elasticsearch/data/config - ES_PATH_CONF
    link:/enrichment-shared-volume/certificates
    link:/enrichment-shared-volume/elasticsearch/*
    link:/usr/share/elasticsearch/config/*






    [[ ! -z "${ES_PATH_CONF}/elasticsearch.keystore" ]] && /usr/share/elasticsearch/bin/elasticsearch-keystore create && /usr/share/elasticsearch/bin/elasticsearch-setup-passwords auto -b -v > ${ES_PATH_CONF}/elasticsearch-setup-passwords.log;
    echo "Passwords:";
    echo "elastic:`cat ${ES_PATH_CONF}/elasticsearch-setup-passwords.log | grep "PASSWORD elastic" | cut -d " " -f 4`";
    echo "kibana:`cat ${ES_PATH_CONF}/elasticsearch-setup-passwords.log | grep "PASSWORD kibana" | cut -d " " -f 4`";
    rm ${ES_PATH_CONF}/elasticsearch-setup-passwords.log;




    rm ${ES_PATH_CONF}/elasticsearch.keystore ${ES_PATH_CONF}/bundle.zip;
    [[ ! -f ${ES_PATH_CONF}/bundle.zip ]] && /usr/share/elasticsearch/bin/elasticsearch-certutil cert --silent --pem --in ${ES_PATH_CONF}/instances.yml -out ${ES_PATH_CONF}/bundle.zip;
    echo "I'm here again!";
    unzip -o ${ES_PATH_CONF}/bundle.zip -d ${ES_PATH_CONF}/certificates;
    [[ ! -z "${ES_PATH_CONF}/elasticsearch.keystore" ]] && /usr/share/elasticsearch/bin/elasticsearch & sleep 120 && /usr/share/elasticsearch/bin/elasticsearch-keystore create && /usr/share/elasticsearch/bin/elasticsearch-setup-passwords auto -b -v;
    find ${ES_PATH_CONF}/;
    chown -R 1000:1000 ${ES_PATH_CONF}/;





kubectl logs es-cluster-0 elasticsearch-init -n es-test



/usr/share/elasticsearch/bin/elasticsearch-setup-passwords auto -b -v -u "http://localhost:9201"



echo "Creating symlinks to Elasticsearch config files on shared volume";
ln -s /enrichment-shared-volume/certificates ${ES_PATH_CONF}/certificates 2> /dev/null;
for file in /enrichment-shared-volume/elasticsearch/*; do ln -s ${file} ${ES_PATH_CONF}/${file##*/} 2> /dev/null; done;
for file in /usr/share/elasticsearch/config/*; do ln -s ${file} ${ES_PATH_CONF}/${file##*/} 2> /dev/null; done;
find ${ES_PATH_CONF}/;
rm ${ES_PATH_CONF}/elasticsearch.keystore ${ES_PATH_CONF}/bundle.zip;
[[ ! -f ${ES_PATH_CONF}/bundle.zip ]] && /usr/share/elasticsearch/bin/elasticsearch-certutil cert --silent --pem --in ${ES_PATH_CONF}/instances.yml -out ${ES_PATH_CONF}/bundle.zip;
echo "I'm here again!";
unzip -o ${ES_PATH_CONF}/bundle.zip -d ${ES_PATH_CONF}/certificates;
chown -R 1000:1000 ${ES_PATH_CONF};
chown -R 1000:1000 /enrichment-shared-volume/certificates;
chown -R 1000:1000 /enrichment-shared-volume/elasticsearch;





printf "passwd" | /usr/share/elasticsearch/bin/elasticsearch-keystore add -x "bootstrap.password"




kubectl exec es-cluster-0 -c elasticsearch-certs -n es-test -- curl https://127.0.0.1:9200/_cluster/health --key /enrichment-shared-volume/certs/es-cluster-0/es-cluster-0.key --cert /enrichment-shared-volume/certs/es-cluster-0/es-cluster-0.crt --cacert /enrichment-shared-volume/certs/ca/ca.crt -u elastic:6sd1SdjgnaSD40lG2TK7 -k -v


kubectl exec kibana-988f6574-vwlwz -c kibana-init -n es-test -- curl https://es-cluster-0:9200/_cluster/health --key /enrichment-shared-volume/certs/es-cluster-0/es-cluster-0.key --cert /enrichment-shared-volume/certs/es-cluster-0/es-cluster-0.crt --cacert /enrichment-shared-volume/certs/ca/ca.crt -u elastic:6sd1SdjgnaSD40lG2TK7 -k -v




kubectl exec es-cluster-0 -c elasticsearch-certs -n es-test -- curl https://127.0.0.1:9200/_security/user/elastic/_password --key /enrichment-shared-volume/certs/es-cluster-0/es-cluster-0.key --cert /enrichment-shared-volume/certs/es-cluster-0/es-cluster-0.crt --cacert /enrichment-shared-volume/certs/ca/ca.crt -u elastic:6sd1SdjgnaSD40lG2TK7 -k -v